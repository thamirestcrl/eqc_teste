
# preparar_dados.py
# OBJETIVO: Converter o arquivo Excel pesado em um arquivo .parquet leve e rápido
# para ser usado no aplicativo Streamlit. Execute este script apenas uma vez.

import pandas as pd

# 1. Definir os nomes dos arquivos
arquivo_excel = "data/MICRODADOS_DE_VIOLÊNCIA_DOMÉSTICA_JAN_2015_A_SET_2025.xlsx"
arquivo_otimizado = "dados_app.parquet"

print("Lendo o arquivo Excel (isso pode demorar um pouco)...")

# 2. Ler o arquivo Excel e limpar os nomes das colunas (equivalente a janitor::clean_names)
df = pd.read_excel(arquivo_excel, sheet_name="Plan1")
df.columns = (
    df.columns.str.lower()
    .str.replace(" ", "_", regex=False)
    .str.normalize("NFKD")
    .str.encode("ascii", errors="ignore")
    .decode("utf-8")
)

# 3. Renomear e processar os dados (equivalente a dplyr::mutate)
if "data_do_fato" in df.columns:
    df.rename(columns={"data_do_fato": "data"}, inplace=True)

# Converte para data, extrai ano e limpa a coluna 'natureza'
df["data"] = pd.to_datetime(df["data"])
df["ano"] = df["data"].dt.year
df["natureza"] = df["natureza"].str.replace(
    "POR VIOLÊNCIA DOMÉSTICA/FAMILIAR", "", regex=False
).str.strip()

# Filtra anos inválidos (equivalente a dplyr::filter)
df_limpo = df[df["ano"] < 2025].copy()

# 4. Seleciona apenas as colunas necessárias (equivalente a dplyr::select)
colunas_necessarias = ["ano", "natureza", "regiao_geografica"]
df_final = df_limpo[colunas_necessarias]

# 5. Salvar o arquivo otimizado em formato Parquet
df_final.to_parquet(arquivo_otimizado)

print(f"Arquivo '{arquivo_otimizado}' criado com sucesso!")
print("Agora você pode executar o app.py.")
